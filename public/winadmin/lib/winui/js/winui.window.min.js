/**
 @Name：winui.window 窗口管理模块
 @Author：Leo
 @License：MIT
    
 */
layui.define(["layer","winui"],function(n){"use strict";var t=layui.jquery,r="winui-this",o=".layui-layer-title",u=40,e=function(){this.settings={type:2,anim:0,miniAnim:0,maxOpen:-1,area:["70vw","80vh"],offset:"auto",min:!0,max:!0,refresh:!1};this.minisizeAnim=["anim-minisize0","anim-minisize1"]};e.prototype.config=function(n){n=n||{};for(var t in n)this.settings[t]=n[t];return this};e.prototype.open=function(n){var e=this,a,f,s,h,l;if(i.getWindow(n.id))return e.setTop(n.id),t(".winui-start").addClass("layui-hide"),t(".winui-taskbar-start").removeClass(r),n.id;if(winui.taskAuto()){if(a=layer.open({id:n.id||winui.guid(),type:n.type||this.settings.type,title:n.title||"",content:n.content||"",area:n.area||this.settings.area,offset:n.offset||this.settings.offset,anim:n.anim||this.settings.anim,move:o,shade:n.shade||0,maxmin:!0,moveOut:!0,skin:"winui-window",zIndex:layer.zIndex,end:n.end||function(){},success:function(n){i.setWindowBody(n)},cancel:function(n,r){var u,f,e;t(r).addClass("layui-hide");u=i.getTaskItemByWindowDom(r);t(u).remove();f=i.getTopWindow();e=i.getTaskItemByWindowDom(f);i.selectDom(e)},min:function(n){return e.minimize(n),!1},full:function(n){if(t(n).find(".layui-layer-min").css("display",""),t(n).find(".layui-layer-max.layui-layer-maxmin").html('<i class="fa fa-window-restore" style="font-size:14px;left:18px;top:10px" ><i>'),t("body").attr("class").replace(/\btaskbarIn.*?\b/g,"")!==t("body").attr("class")){switch(winui.settings.taskbarMode){case"top":t(n).css("top",u+"px");break;case"bottom":t(n).css("top","0px")}t(n).css("height",parseInt(t(n).css("height").replace("px",""))-u+"px");t(n).find(".layui-layer-content").css("height",parseInt(t(n).find(".layui-layer-content").css("height").replace("px",""))-u+"px");var r=t(n).find("iframe")[0];r&&t(r).css("height",parseInt(t(r).css("height").replace("px",""))-u+"px")}i.setWindowBody(n)},restore:function(n){t(n).find(".layui-layer-max").html('<i class="layui-icon" style="font-size:12px;left:18px;" >&#xe626;<i>');i.setWindowBody(n)},resizing:function(n){i.setWindowBody(n)}}),f=i.getWindow(n.id),(n.type||this.settings.type)==2&&(n.refresh===undefined?this.settings.refresh:n.refresh)){t(f).find(".layui-layer-setwin").prepend('<a class="layui-layer-ico layui-layer-refresh"><i class="layui-icon" style="font-size:14px;left:17px;font-weight:600;">&#x1002;<i><\/a>');t(f).find(".layui-layer-refresh").on("click",function(){var n=t(f).find("iframe");try{n.attr("src",n[0].contentWindow.location.href)}catch(e){n.attr("src",n.attr("src"))}})}t(f).find(".layui-layer-max").html('<i class="layui-icon" style="font-size:12px;left:18px;" >&#xe626;<i>');t(f).find(".layui-layer-close").html('<i class="layui-icon">&#x1006;<i>');switch(n.maxOpen||this.settings.maxOpen){case 1:if((n.anim||this.settings.anim)!==-1)t(f).one("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){t(f).find(".layui-layer-max").trigger("click")});else t(f).find(".layui-layer-max").trigger("click");break;case 2:switch(winui.settings.taskbarMode){case"top":s=u+"px";break;case"bottom":s="0"}layer.style(a,{top:s,left:"0",width:t(window).width()+"px",height:t(window).height()-u+"px"})}(n.min===undefined?this.settings.min:n.min)||t(f).find(".layui-layer-min").remove();(n.max===undefined?this.settings.max:n.max)||t(f).find(".layui-layer-max").remove();h=i.addTaskItem(n.id,n.title);i.selectDom(h);i.resetMouseUp(h,c.taskItemMouseUp);l=0;t(f).find(o).on("mousedown",function(){t(".layui-layer-move").css("cursor","default");var n=(new Date).getTime();n-l<300&&t(f).find(".layui-layer-max").trigger("click");l=n});t(f).find(".layui-layer-setwin").children("a").removeAttr("href");layer.setTop(t(f));e.setTop(f);t(f).on("mousedown",function(){var n=i.getTaskItemByWindowDom(this);i.selectDom(n)});return t(".winui-start").addClass("layui-hide"),t(".winui-taskbar-start").removeClass(r),n.id}};e.prototype.minimize=function(n){var u,f,e,o,s;n!==undefined?(u=i.getWindow(n),f=this.minisizeAnim[this.settings.miniAnim],f?(t(u).addClass(f),setTimeout(function(){var n,e,o;t(u).addClass("layui-hide").removeClass(f);n=i.getTaskItemByWindowDom(u);t(n).removeClass(r);e=i.getTopWindow();o=i.getTaskItemByWindowDom(e);i.selectDom(o)},200)):(t(u).addClass("layui-hide"),e=i.getTaskItemByWindowDom(u),t(e).removeClass(r),o=i.getTopWindow(),s=i.getTaskItemByWindowDom(o),i.selectDom(s))):(t(".winui-window").addClass("layui-hide"),t(".winui-task-item").removeClass(r))};e.prototype.close=function(n){var r=i.getWindow(n);t(r).find(".layui-layer-ico.layui-layer-close").trigger("click")};var s=typeof HTMLElement=="object"?function(n){return n instanceof HTMLElement}:function(n){return n&&typeof n=="object"&&n.nodeType===1&&typeof n.nodeName=="string"},h=function(n){return n instanceof t},i={getWindowIdByWindow:function(n){return t(n).find(".layui-layer-content").prop("id")},getTaskItemByWindowDom:function(n){var r=t(n).find(".layui-layer-content").prop("id");return i.getTaskItem(r)},getTaskItem:function(n){return typeof n=="string"?t(".winui-task-item[win-id="+n+"]")[0]:s(n)?n:h(n)?n[0]:null},getWindow:function(n){return typeof n=="string"?t(".winui-window:has(.layui-layer-content[id="+n+"])")[0]:s(n)?n:h(n)?n[0]:null},selectDom:function(n){t(n).addClass(r).siblings().removeClass(r)},addTaskItem:function(n,i){var r=t('<li win-id="'+n+'" class="winui-task-item">'+i+"<\/li>");return t(".winui-taskbar-task").append(r),r},resetMouseUp:function(n,i){if(typeof i=="function")t(n).off("mouseup").on("mouseup",i)},getTopWindow:function(){var n,i=0;return t(".winui-window:visible").each(function(){var r=t(this).css("z-index");r>i&&(n=this)}),n},isTopWindow:function(n){if(!t(n).is(":visible"))return!1;var r=t(n).css("z-index"),i=!0;return t(".winui-window:visible").each(function(){var n=t(this).css("z-index");if(n>r)return i=!1}),i},setWindowBody:function(n){var i=t(n).find("iframe").contents().find("body.winui-window-body");i&&i.css("height",t(n).find("iframe").css("height"))},showWindow:function(n){t(i.getWindow(n)).removeClass("layui-hide")},hideWindow:function(n){t(i.getWindow(n)).addClass("layui-hide")}},c={sp:function(n){layui.stope(n)},taskItemMouseUp:function(n){var e,f,p,a,v,y,l,h,s;if(n||(n=window.event),e=this,n.button==0&&(f=i.getWindow(t(e).attr("win-id")),p=i.getWindowIdByWindow(f),i.isTopWindow(f)?(i.hideWindow(f),a=i.getTaskItemByWindowDom(f),t(a).removeClass(r),v=i.getTopWindow(),y=i.getTaskItemByWindowDom(v),i.selectDom(y)):(t(f).is(":hidden")&&(i.showWindow(f),i.selectDom(this)),t(f).find(o).trigger("mousedown").trigger("mouseup"))),n.button==2){i.selectDom(e);l=t(e).offset().left;h="";switch(winui.settings.taskbarMode){case"top":h="top:"+u+"px;left:"+(l-20)+"px;";break;case"bottom":h="bottom:"+u+"px;left:"+(l-20)+"px;"}s='<ul class="task-contextmenu" style="'+h+'">';s+='<li class="closeAll">&#x5173;&#x95ED;&#x5168;&#x90E8;&#x7A97;&#x53E3;<\/li>';s+='<li class="closeOther">&#x5173;&#x95ED;&#x5176;&#x4ED6;&#x7A97;&#x53E3;<\/li>';s+='<li class="close"><i class="fa fa-power-off fa-fw"><\/i>&#x5173;&#x95ED;&#x5F53;&#x524D;&#x7A97;&#x53E3;<\/li>';s+="<\/ul>";t(".task-contextmenu").remove();t("body").append(s);t(".task-contextmenu .closeAll").off("mouseup").on("mouseup",function(n){n||(n=window.event);n.button==0&&t(".winui-window.layui-layer").find(".layui-layer-ico.layui-layer-close").trigger("click");t(".task-contextmenu").remove()});t(".task-contextmenu .closeOther").off("mouseup").on("mouseup",function(n){if(n||(n=window.event),n.button==0){var r=i.getWindow(t(e).attr("win-id"));t(".winui-window.layui-layer").not(r).find(".layui-layer-ico.layui-layer-close").trigger("click")}t(".task-contextmenu").remove()});t(".task-contextmenu .close").off("mouseup").on("mouseup",function(n){if(n||(n=window.event),n.button==0){var r=i.getWindow(t(e).attr("win-id"));t(r).find(".layui-layer-ico.layui-layer-close").trigger("click")}t(".task-contextmenu").remove()});t(".task-contextmenu li").on("click mousedown",c.sp)}}},f=new e;f.setTop=function(n){var r=i.getWindow(n);r&&(t(r).is(":hidden")&&(t(i.getWindow(r)).removeClass("layui-hide"),i.selectDom(this)),t(r).trigger("mousedown"))};f.msg=function(n,t,i){t||(t={offset:"40px"});t.zIndex=layer.zIndex;layer.msg(n,t,i)};f.confirm=function(n,i,r,u){var f=typeof i=="function";f&&(u=r,r=i,i={});i.zIndex=layer.zIndex;i.skin="layer-ext-winconfirm";layer.confirm(n,i,r,u);t(".layer-ext-winconfirm").find(".layui-layer-close").html('<i class="layui-icon">&#x1006;<i>');t(".layui-layer-move").remove();t(".layer-ext-winconfirm").find(".layui-layer-setwin").children("a").removeAttr("href")};f.load=function(n,t){return n=n||1,t=t||{},t.zIndex=layer.zIndex,layer.load(n,t)};f.openTheme=function(){var n=this;t.get(winui.path+"html/setting/theme.html",{},function(t){n.open({id:"winui-theme",type:1,title:"主题",content:t})})};winui.window=f;n("window",{});delete layui.window});